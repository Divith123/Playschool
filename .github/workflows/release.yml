name: Release All Platforms

on:
  push:
    tags:
      - 'v*' # Trigger on tags like v1.0.0

jobs:
  release-all:
    name: Release All Platforms
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: android
            build-command: flutter build apk --release
            artifact-name: playschool-android-apk
            artifact-path: build/app/outputs/flutter-apk/app-release.apk
          - os: ubuntu-latest
            platform: linux
            build-command: |
              flutter config --enable-linux-desktop
              sudo apt-get update
              sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev
              flutter build linux --release
              cd build/linux/x64/release/bundle
              tar -czf ../playschool_linux.tar.gz .
              mv ../playschool_linux.tar.gz .
            artifact-name: playschool-linux-app
            artifact-path: build/linux/x64/release/bundle/playschool_linux.tar.gz
          - os: windows-latest
            platform: windows
            build-command: |
              flutter config --enable-windows-desktop
              flutter build windows --release
              cd build\windows\x64\runner\Release
              Compress-Archive -Path playschool.exe,*.dll -DestinationPath playschool_windows.zip
            artifact-name: playschool-windows-app
            artifact-path: build\windows\x64\runner\Release\playschool_windows.zip
          - os: macos-latest
            platform: macos
            build-command: |
              flutter config --enable-macos-desktop
              flutter build macos --release
              cd build/macos/Build/Products/Release
              tar -czf playschool_macos.tar.gz playschool.app
            artifact-name: playschool-macos-app
            artifact-path: build/macos/Build/Products/Release/playschool_macos.tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: ${{ matrix.platform == 'windows' && 'x64' || '' }}

      - name: Setup Java (for Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Get Dependencies
        run: flutter pub get

      - name: Build ${{ matrix.platform }}
        run: ${{ matrix.build-command }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-path }}

      - name: Create Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.artifact-path }}
          name: Release ${{ github.ref_name }} - ${{ matrix.platform }}
          body: |
            Automated release for ${{ matrix.platform }} - version ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: release-all
    if: always()
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-releases

      - name: Create Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Android APK" >> $GITHUB_STEP_SUMMARY
          echo "✅ Linux App" >> $GITHUB_STEP_SUMMARY
          echo "✅ Windows App" >> $GITHUB_STEP_SUMMARY
          echo "✅ macOS App" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All platforms released successfully for version ${{ github.ref_name }}!" >> $GITHUB_STEP_SUMMARY
